## MetLife SSO Integration and Architecture Document

This document provides a comprehensive walkthrough of the MetLife SSO setup, including various environments, flows, and components involved in integrating PingFederate, PingDirectory, CosmosDB, and legacy systems.

---

### Overview of Authentication Flow with PingFederate

The user initiates the SSO request via a third-party identity provider (TPA). This request contains SAML assertions including identifiers like `employeeID` and `companyno`. These values are mapped in the PingFederate system.

1. **External User Initiation:**
   - SAML request is received with `nameid = employeeID` and `companyno = 123123`.
   - PingFederate receives the request and attempts to authenticate the user.

2. **Primary Flow:**
   - If the user is found in PingDirectory, they're authenticated directly.
   - If not, PingFederate routes the request to APIM (`apim.metlife.com/getprofile`).

3. **Fallback User Store Check:**
   - APIM acts as an orchestrator.
   - A microservice (hosted in AKS) queries CosmosDB collections to fetch the required user profile or group membership details.

4. **CosmosDB Check:**
   - CosmosDB (collections like `groupCustomerMember`, `userProfile`, etc.) are queried.
   - If the user data is present, the details are returned.
   - Data is written back to PingDirectory to cache results for next requests.

5. **Final Authorization:**
   - PingFederate completes the SSO flow by issuing a cookie and redirecting to the target application (MyBenefits, MetOnline, GSSP, etc.).

---

### Metadata and Profile Handling

- PingFederate uses metadata values to identify the third-party entity.
- Group numbers and customer numbers in the SAML assertion help identify the plan source.
- The application MyBenefits is used temporarily instead of SOH for TPA testing.
- Federation checks whether a group is enabled for FSO.

---

### Simplifying the Flow

A proposal was discussed to streamline the multi-step MGTAS verification:

- Instead of going through MyBenefits and MGTAS sequentially, PingFederate could handle this through a one-step validation using CosmosDB.
- CosmosDB contains group-level and user-level entries that map out the user's coverage (e.g., pet insurance, disability).

This reduces latency and avoids duplicated checks in MGTAS and LDAP.

---

### CosmosDB Structure & Integration



- The database used for login is `login_mod`.
- Important collections: `groupCustomerMember`, `user`, `userProfile`, etc.
- CosmosDB API is called from AKS microservice to read and write user details.
- A REST API endpoint in APIM interacts with this database.


---

### PingDirectory and LDAP Synchronization

PingDirectory is synced with the legacy IBSE LDAP. This ensures backward compatibility. Replication is managed between:

- **Legacy OUD** (Oracle Unified Directory) / IBSE LDAP
- **PingDirectory** as a modern directory



---

### Final Workflow Summary (Post-Migration Target State)

1. SAML from external user hits PingFederate.
2. PingFederate checks PingDirectory for user.
3. If not found, request is sent via APIM.
4. APIM calls the microservice hosted in AKS.
5. Microservice reads from CosmosDB (`groupCustomerMember`, `userProfile`).
6. User data is saved back into PingDirectory.
7. PingFederate issues authentication token and redirects to the target app.

---

### Observations & Notes

- **CMP Service**: Customer Managed Profile service integration is referenced. CMP APIs help consolidate customer configurations.
- **Cookies**: Both PingFederation and Siteminder cookies are used temporarily during dual migration phases.
- **Redirection**: Final goal is to decommission Siteminder and retain only Ping-based authentication.
- **Target Apps**: Include MyBenefits, GSSP, MetOnline, etc.

---

### Legacy Architecture (for context)


- Initial login starts with MIS authentication using IBSE.
- Then redirects go through USD Login -> Servicing Page.
- Underlying APIs retrieve user profile, group indicators, and eligible products from:
  - IBSE DB
  - eDPM DB
  - Profile DB

---

This concludes the deep-dive explanation of MetLifeâ€™s evolving SSO infrastructure with relevant architecture components, workflows, and screenshots for clarity.

