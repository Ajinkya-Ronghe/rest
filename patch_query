WITH asset_data AS (
    SELECT
        ci_item_computer_name AS computer_name,
        ci_item_operating_system AS operating_system,
        ci_item_last_seen_at AS last_seen
    FROM esh_main.ceh_tn_asset_report_fs_hardware_inventory_report
),
patch_data AS (
    SELECT
        id,
        computer_name,
        custom_tags,
        operating_system,
        patch_installation_state_title AS title,
        patch_installation_state_install_status AS install_status,
        patch_installation_state_severity AS severity,
        patch_installation_state_release_date AS release_date,
        patch_installation_state_kb_articles AS kb_articles,
        patch_installation_state_product AS product,
        patch_installation_state_classification AS classification,
        patch_installation_state_size_in_bytes AS size_in_bytes,
        patch_installation_state_cve_ids AS cve_ids
    FROM esh_main.ceh_tn_patch_installation_state_all_status
    WHERE patch_installation_state_install_status = 'Not Installed'
),
combined_data AS (
    SELECT
        asset_data.computer_name,
        patch_data.custom_tags,
        asset_data.operating_system,
        patch_data.title,
        patch_data.install_status,
        patch_data.severity,
        patch_data.release_date,
        patch_data.kb_articles,
        patch_data.product,
        patch_data.classification,
        asset_data.last_seen,
        patch_data.size_in_bytes,
        patch_data.cve_ids,
        NOW() AS timenow
    FROM asset_data
    INNER JOIN patch_data ON asset_data.computer_name = patch_data.computer_name
),
filtered_data AS (
    SELECT
        *,
        NOW() - INTERVAL '30 days' AS days_ago,
        EXTRACT(EPOCH FROM NOW()) - EXTRACT(EPOCH FROM last_seen::timestamp) AS data_age,
        CASE
            WHEN last_seen IS NOT NULL THEN EXTRACT(EPOCH FROM last_seen::timestamp) - (5 * 3600)
            ELSE NULL
        END AS utc_last_seen
    FROM combined_data
    WHERE title IS NOT NULL
      AND release_date::timestamp <= NOW() - INTERVAL '30 days'
      AND EXTRACT(EPOCH FROM NOW()) - EXTRACT(EPOCH FROM last_seen::timestamp) < 108000
)
SELECT DISTINCT
    computer_name,
    custom_tags,
    operating_system,
    title,
    install_status,
    severity,
    release_date,
    kb_articles,
    product,
    classification,
    TO_TIMESTAMP(utc_last_seen) AT TIME ZONE 'UTC' AS last_seen
FROM filtered_data
ORDER BY computer_name;
