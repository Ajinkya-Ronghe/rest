WITH asset_data AS (
    SELECT
        ci_item_computer_name AS computer_name,
        ci_item_operating_system AS operating_system,
        CASE
            WHEN ci_item_last_seen_at = 'Not Available' THEN NULL
            ELSE ci_item_last_seen_at
        END AS last_seen
    FROM esh_main.ceh_tn_asset_report_fs_hardware_inventory_report
    WHERE ci_item_last_seen_at IS DISTINCT FROM 'Not Available'
),
patch_data AS (
    SELECT
        id,
        computer_name,
        custom_tags,
        operating_system,
        patch_installation_state_title AS title,
        patch_installation_state_install_status AS install_status,
        patch_installation_state_severity AS severity,
        patch_installation_state_release_date AS release_date,
        patch_installation_state_kb_articles AS kb_articles,
        patch_installation_state_product AS product,
        patch_installation_state_classification AS classification,
        patch_installation_state_size_in_bytes AS size_in_bytes,
        patch_installation_state_cve_ids AS cve_ids
    FROM esh_main.ceh_tn_patch_installation_state_all_status
    WHERE patch_installation_state_install_status = 'Not Installed'
),
combined_data AS (
    SELECT
        a.computer_name,
        p.custom_tags,
        a.operating_system,
        p.title,
        p.install_status,
        p.severity,
        p.release_date,
        p.kb_articles,
        p.product,
        p.classification,
        a.last_seen,
        p.size_in_bytes,
        p.cve_ids,
        NOW() AS timenow
    FROM asset_data a
    INNER JOIN patch_data p ON a.computer_name = p.computer_name
),
filtered_data AS (
    SELECT
        *,
        NOW() - INTERVAL '30 days' AS days_ago,
        CASE
            WHEN last_seen IS NOT NULL THEN EXTRACT(EPOCH FROM NOW()) - EXTRACT(EPOCH FROM last_seen::timestamp)
            ELSE NULL
        END AS data_age,
        CASE
            WHEN last_seen IS NOT NULL THEN EXTRACT(EPOCH FROM last_seen::timestamp) - (5 * 3600)
            ELSE NULL
        END AS utc_last_seen
    FROM combined_data
    WHERE title IS NOT NULL
      AND release_date::timestamp <= NOW() - INTERVAL '30 days'
      AND (last_seen IS NULL OR EXTRACT(EPOCH FROM NOW()) - EXTRACT(EPOCH FROM last_seen::timestamp) < 108000)
)
SELECT DISTINCT
    computer_name,
    custom_tags,
    operating_system,
    title,
    install_status,
    severity,
    release_date,
    kb_articles,
    product,
    classification,
    CASE
        WHEN utc_last_seen IS NOT NULL THEN TO_TIMESTAMP(utc_last_seen) AT TIME ZONE 'UTC'
        ELSE NULL
    END AS last_seen
FROM filtered_data
ORDER BY computer_name;
