WITH deduped_data AS (
    SELECT DISTINCT ON (computer_name) 
        computer_name,
        custom_tags,
        name,
        status,
        sub_status,
        "time" AS deploy_time
    FROM esh_main.ceh_tn_splunk_custom_deploy_sensor
),
filtered_data AS (
    SELECT 
        computer_name,
        custom_tags,
        name,
        status,
        sub_status,
        TO_CHAR(TO_TIMESTAMP("time", 'YYYY-MM-DD"T"HH24:MI"Z"'), 'MM/DD/YYYY') AS deploy_time
    FROM deduped_data
    WHERE EXTRACT(EPOCH FROM NOW()) - 7776000 <= EXTRACT(EPOCH FROM TO_TIMESTAMP("time", 'YYYY-MM-DD"T"HH24:MI"Z"'))
)
SELECT 
    status,
    COUNT(*) AS count
FROM filtered_data
GROUP BY status;
