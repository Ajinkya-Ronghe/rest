WITH days_calculated AS (
    SELECT
        NOW() AS current_time,
        NOW() - INTERVAL '90 days' AS daysago_epoch -- Calculates `daysago`
),
deduped_data AS (
    SELECT DISTINCT ON (computer_name) 
        computer_name,
        custom_tags,
        name,
        status,
        sub_status,
        "time" -- Keep the raw "time" field here for further processing
    FROM esh_main.ceh_tn_splunk_custom_deploy_sensor
),
filtered_data AS (
    SELECT 
        d.computer_name,
        d.custom_tags,
        d.name,
        d.status,
        d.sub_status,
        TO_CHAR(TO_TIMESTAMP(d."time", 'YYYY-MM-DD"T"HH24:MI"Z"'), 'MM/DD/YYYY') AS deploy_time, -- Converts "time" to formatted Deploy_Time
        TO_TIMESTAMP(d."time", 'YYYY-MM-DD"T"HH24:MI"Z"') AS unix_timestamp -- Converts "time" to a proper timestamp for comparison
    FROM deduped_data d, days_calculated dc
    WHERE TO_TIMESTAMP(d."time", 'YYYY-MM-DD"T"HH24:MI"Z"') >= dc.daysago_epoch -- Compares with `daysago`
),
status_counts AS (
    SELECT 
        status,
        COUNT(*) AS count
    FROM filtered_data
    GROUP BY status
),
ranked_statuses AS (
    SELECT 
        status,
        count,
        ROW_NUMBER() OVER (ORDER BY count DESC) AS rank -- Ranks statuses by their count in descending order
    FROM status_counts
),
top_7_and_other AS (
    SELECT 
        CASE 
            WHEN rank <= 7 THEN status
            ELSE 'Other' -- Assign "Other" to all ranks beyond 7
        END AS grouped_status,
        CASE 
            WHEN rank <= 7 THEN count
            ELSE 0 -- For "Other", we will sum up the counts later
        END AS individual_count,
        rank
    FROM ranked_statuses
),
final_result AS (
    SELECT 
        grouped_status,
        SUM(individual_count) + 
        CASE 
            WHEN grouped_status = 'Other' THEN (
                SELECT SUM(count) 
                FROM ranked_statuses 
                WHERE rank > 7
            )
            ELSE 0
        END AS total_count
    FROM top_7_and_other
    GROUP BY grouped_status
)
SELECT * FROM final_result;
