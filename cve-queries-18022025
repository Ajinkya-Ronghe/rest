WITH combined AS (
    SELECT
        r.cve_id,
        r.computer_name,
        r.remediation_date,
        d.cvss_v3_severity  AS v3_severity,
        d.severity          AS v2_severity,
        d.is_cisa_kev
    FROM esh_main.ceh_tn_fs_remediated_cves_90_days AS r
    JOIN esh_main.ceh_tn_fs_cve_vulnerability_findings_details AS d
         ON r.cve_id = d.check_id
    WHERE d.is_cisa_kev IS NOT NULL
      AND d.cvss_v3_severity IS NOT NULL
      AND d.severity IS NOT NULL
)
SELECT 
    v3_severity,
    COUNT(*) AS total_count
FROM (
    -- Deduplicate on (computer_name, cve_id), 
    -- and only consider rows where remediation_date IS NOT NULL
    SELECT DISTINCT ON (computer_name, cve_id) *
    FROM combined
    WHERE remediation_date IS NOT NULL
) AS deduped
GROUP BY 
    v3_severity
ORDER BY 
    v3_severity;