WITH distinct_computers AS (
    SELECT DISTINCT ON (computer_name)
        computer_name,
        custom_tags,
        name,
        status,
        sub_status,
        CAST("time" AS TIMESTAMP) AS deploy_time
    FROM esh_main.ceh_tn_splunk_custom_deploy_sensor
    WHERE "time" IS NOT NULL
      AND "time" ~ '^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?Z$'
      AND CAST("time" AS TIMESTAMP) >= NOW() - INTERVAL '90 days'
      AND status = 'Success'
),
name_counts AS (
    SELECT 
        name,
        COUNT(*) AS count_by_name
    FROM distinct_computers
    GROUP BY name
),
ranked_names AS (
    SELECT 
        name,
        count_by_name,
        ROW_NUMBER() OVER (ORDER BY count_by_name DESC) AS rank
    FROM name_counts
),
final_result AS (
    SELECT 
        name,
        count_by_name
    FROM ranked_names
    WHERE rank <= 7
    UNION ALL
    SELECT 
        'Other (' || COUNT(*) || ')' AS name,
        SUM(count_by_name) AS count_by_name
    FROM ranked_names
    WHERE rank > 7
    HAVING COUNT(*) > 0 -- Only include "Other" if there are remaining names
)
SELECT 
    name,
    count_by_name
FROM final_result
ORDER BY 
    CASE 
        WHEN name LIKE 'Other (%)' THEN 9999
        ELSE count_by_name 
    END DESC, name;
