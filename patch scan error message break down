WITH extracted_errors AS (
    SELECT
        custom_tags AS "Custom Tags",
        operating_system AS "Operating System",
        patch_has_enforced_scan_configuration AS "Has Enforced Scan Configuration",
        patch_is_process_running AS "Is Process Running",
        days_since_successful_scan AS "Days Since Successful Scan",
        patch_coverage_status_details::json ->> 'Status' AS "Status",
        patch_coverage_status_details::json ->> 'Detail' AS "Detail",
        patch_scan_error_elements->>'Error Message' AS "Patch Scan Error Message",
        computer_name
    FROM 
        esh_main.ceh_tanium_core_and_patch_health,
        jsonb_array_elements(patch_scan_errors::jsonb) AS patch_scan_error_elements
    WHERE 
        patch_scan_errors IS NOT NULL
        AND patch_scan_errors::jsonb != '[]'::jsonb
)
SELECT 
    "Custom Tags",
    "Operating System",
    "Has Enforced Scan Configuration",
    "Is Process Running",
    "Days Since Successful Scan",
    "Status",
    "Detail",
    "Patch Scan Error Message",
    COUNT(computer_name) AS "Count by Patch Scan Error Message"
FROM 
    extracted_errors
WHERE 
    "Patch Scan Error Message" != 'No Scan Errors'
GROUP BY 
    "Custom Tags",
    "Operating System",
    "Has Enforced Scan Configuration",
    "Is Process Running",
    "Days Since Successful Scan",
    "Status",
    "Detail",
    "Patch Scan Error Message"
ORDER BY 
    COUNT(computer_name) DESC;
