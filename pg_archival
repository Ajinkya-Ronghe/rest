CREATE OR REPLACE FUNCTION archive_old_data(
    original_table_name TEXT,
    days_threshold INTEGER
)
RETURNS TEXT AS $$
DECLARE
    backup_table_name TEXT;
    full_original_table TEXT;
    full_backup_table TEXT;
    table_exists BOOLEAN;
BEGIN
    -- Generate full table names with schema
    full_original_table := 'esh_main.' || original_table_name;
    backup_table_name := original_table_name || '_bkp';
    full_backup_table := 'esh_main.' || backup_table_name;

    -- Check if the backup table exists
    SELECT EXISTS (
        SELECT FROM pg_tables 
        WHERE schemaname = 'esh_main' 
        AND tablename = backup_table_name
    ) INTO table_exists;

    -- Create the backup table if it doesn't exist
    IF NOT table_exists THEN
        RAISE NOTICE 'Creating backup table: %', full_backup_table;
        EXECUTE format(
            'CREATE TABLE %I (LIKE %I INCLUDING ALL)',
            full_backup_table, full_original_table
        );
    ELSE
        RAISE NOTICE 'Backup table already exists: %', full_backup_table;
    END IF;

    -- Insert older data into the backup table
    RAISE NOTICE 'Inserting data into backup table: %', full_backup_table;
    EXECUTE format(
        'INSERT INTO %I SELECT * FROM %I WHERE created_at < NOW() - INTERVAL ''1 day'' * $1',
        full_backup_table, full_original_table
    )
    USING days_threshold;

    -- Delete the archived data from the original table
    RAISE NOTICE 'Deleting data from original table: %', full_original_table;
    EXECUTE format(
        'DELETE FROM %I WHERE created_at < NOW() - INTERVAL ''1 day'' * $1',
        full_original_table
    )
    USING days_threshold;

    -- Return success message
    RETURN format('Archival Successful: Data older than %s days from %I moved to %I', 
                  days_threshold, full_original_table, full_backup_table);
END;
$$ LANGUAGE plpgsql;
