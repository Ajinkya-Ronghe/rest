WITH processed_data AS (
    SELECT 
        "custom_tags" AS "Custom_Tags", 
        "computer_name" AS "Computer_Name", 
        CAST("cpu_consumption" AS NUMERIC) AS "Total_CPU_Usage", 
        CAST("number_of_processor_cores" AS NUMERIC) AS "Cores",
        100 AS "Total_CPU_Available",
        ROUND(("cpu_consumption"::NUMERIC / "Total_CPU_Available") * 100) AS "CPU_Percentage",
        regexp_matches("high_cpu_processes_5_", '(?P<Process>\\S+)') AS "Process"
    FROM esh_main.ceh_tn_splunk_packet_loss
)
SELECT 
    "Custom_Tags", 
    "Computer_Name", 
    "Total_CPU_Usage" AS "CPU Consumption", 
    "Cores" AS "Number_of_Processor_Cores", 
    "Total_CPU_Available", 
    "CPU_Percentage", 
    "Process"
FROM 
    processed_data
WHERE 
    "CPU_Percentage" >= 90
ORDER BY 
    "Custom_Tags", 
    "Computer_Name";
